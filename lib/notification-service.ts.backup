// ðŸŽ¯ NOTIFICATION SERVICE - SISTEMA DE NOTIFICACIONES AUTOMÃTICAS
// ðŸ“… Fecha: 18 de noviembre de 2025
// âœ… Estado: SISTEMA COMPLETO DE NOTIFICACIONES
//
// ðŸš« REGLAS IMPORTANTES:
// - Todas las notificaciones siguen la lÃ³gica de negocio
// - Cada rol recibe solo notificaciones relevantes
// - Las notificaciones se generan automÃ¡ticamente en los endpoints
// - Mantener consistencia en tipos y mensajes
//
// ðŸ“‹ TIPOS DE NOTIFICACIONES:
// - project_created: Cuando un vendedor crea un proyecto
// - project_pending_approval: Proyecto esperando aprobaciÃ³n de compras
// - project_approved: Proyecto aprobado
// - installer_assigned: Instalador asignado a proyecto
// - budget_request: Solicitud de presupuesto al instalador
// - budget_proposed: Instalador propone presupuesto
// - budget_accepted: Presupuesto aceptado
// - budget_rejected: Presupuesto rechazado
// - project_started: Proyecto iniciado
// - project_completed: Proyecto completado
// - payment_approved: Pago aprobado
// - payment_received: Pago recibido por instalador

import fs from 'fs';
import path from 'path';

const dataFilePath = path.join(process.cwd(), 'public', 'data.json');

// Helper function to read data
function readData() {
  const fileContents = fs.readFileSync(dataFilePath, 'utf8');
  return JSON.parse(fileContents);
}

// Helper function to write data
function writeData(data: any) {
  fs.writeFileSync(dataFilePath, JSON.stringify(data, null, 2));
}

// Helper function to get user by ID
function getUserById(userId: number) {
  const data = readData();
  return data.users?.find((u: any) => u.id === userId);
}

// Helper function to get project by ID
function getProjectById(projectId: number) {
  const data = readData();
  return data.projects?.find((p: any) => p.id === projectId);
}

// Create notification
function createNotification(notification: {
  userId: number;
  type: string;
  title: string;
  message: string;
  data?: any;
}) {
  const fileData = readData();
  const notifications = fileData.notifications || [];

  const newNotification = {
    id: Math.max(...notifications.map((n: any) => n.id), 0) + 1,
    userId: notification.userId,
    type: notification.type,
    title: notification.title,
    message: notification.message,
    data: notification.data || {},
    isRead: false,
    createdAt: new Date().toISOString()
  };

  notifications.push(newNotification);
  writeData({ ...fileData, notifications });

  return newNotification;
}

// ðŸŽ¯ FUNCIONES DE NOTIFICACIONES POR EVENTO

export const NotificationService = {
  // Cuando un vendedor crea un proyecto
  projectCreated: (project: any, createdByUserId: number) => {
    const creator = getUserById(createdByUserId);

    // NotificaciÃ³n al creador
    createNotification({
      userId: createdByUserId,
      type: 'project_created',
      title: 'Proyecto creado exitosamente',
      message: `Has creado el proyecto '${project.projectName}' para el cliente ${project.clientName}`,
      data: {
        projectId: project.id,
        clientName: project.clientName,
        projectName: project.projectName
      }
    });

    // NotificaciÃ³n a compras para aprobaciÃ³n (si no es admin)
    if (creator?.role !== 'admin') {
      const purchasingUsers = readData().users?.filter((u: any) => u.role === 'purchasing') || [];
      purchasingUsers.forEach((user: any) => {
        createNotification({
          userId: user.id,
          type: 'project_pending_approval',
          title: 'Proyecto pendiente de aprobaciÃ³n',
          message: `Nuevo proyecto '${project.projectName}' requiere aprobaciÃ³n de compras`,
          data: {
            projectId: project.id,
            clientName: project.clientName,
            totalCost: project.totalCost
          }
        });
      });

      // NotificaciÃ³n a admin
      const adminUsers = readData().users?.filter((u: any) => u.role === 'admin') || [];
      adminUsers.forEach((user: any) => {
        createNotification({
          userId: user.id,
          type: 'project_pending_approval',
          title: 'Proyecto pendiente de aprobaciÃ³n',
          message: `Proyecto '${project.projectName}' ($${project.totalCost}) requiere tu aprobaciÃ³n`,
          data: {
            projectId: project.id,
            clientName: project.clientName,
            totalCost: project.totalCost
          }
        });
      });
    }
  },

  // Cuando un proyecto se envÃ­a para aprobaciÃ³n
  projectPendingApproval: (project: any, submittedByUserId: number) => {
    // NotificaciÃ³n a compras (rol purchasing) para que apruebe el proyecto
    const purchasingUsers = readData().users?.filter((u: any) => u.role === 'purchasing') || [];
    
    purchasingUsers.forEach((user: any) => {
      createNotification({
        userId: user.id,
        type: 'project_pending_approval',
        title: 'Proyecto pendiente de aprobaciÃ³n',
        message: `El proyecto '${project.projectName}' para ${project.clientName} estÃ¡ esperando tu aprobaciÃ³n`,
        data: {
          projectId: project.id,
          clientName: project.clientName,
          projectName: project.projectName,
          submittedBy: submittedByUserId
        }
      });
    });
  },

  // Cuando un proyecto es aprobado
  projectApproved: (project: any, approvedByUserId: number) => {
    const projectCreator = getUserById(project.createdBy === 'admin' ? 1 : project.createdBy);

    // NotificaciÃ³n al creador del proyecto
    if (projectCreator) {
      createNotification({
        userId: projectCreator.id,
        type: 'project_approved',
        title: 'Proyecto aprobado',
        message: `Tu proyecto '${project.projectName}' ha sido aprobado`,
        data: {
          projectId: project.id,
          approvedBy: getUserById(approvedByUserId)?.name
        }
      });
    }
  },

  // Cuando se asigna un instalador
  installerAssigned: (project: any, assignedByUserId: number) => {
    let installerId: number | null = null;

    if (project.assignedInstaller === 'Carlos RodrÃ­guez') installerId = 4;
    else if (project.assignedInstaller === 'Miguel SÃ¡nchez') installerId = 5;
    else if (project.assignedInstaller === 'Laura MartÃ­nez') installerId = 6;
    else if (project.assignedInstaller === 'Sofia Herrera') installerId = 7;

    if (installerId) {
      const installer = getUserById(installerId);
      if (installer) {
        createNotification({
          userId: installer.id,
          type: 'installer_assigned',
          title: 'Proyecto asignado',
          message: `Te han asignado el proyecto '${project.projectName}' para el cliente ${project.clientName}`,
          data: {
            projectId: project.id,
            clientName: project.clientName,
            assignedBy: getUserById(assignedByUserId)?.name,
            scheduledDate: project.scheduledStart
          }
        });
      }
    }

    // NotificaciÃ³n al creador del proyecto
    const projectCreator = getUserById(project.createdBy === 'admin' ? 1 : project.createdBy);
    if (projectCreator) {
      createNotification({
        userId: projectCreator.id,
        type: 'installer_assigned',
        title: 'Instalador asignado',
        message: `${project.assignedInstaller} ha sido asignado al proyecto '${project.projectName}'`,
        data: {
          projectId: project.id,
          installerName: project.assignedInstaller,
          scheduledDate: project.scheduledStart
        }
      });
    }
  },

  // Solicitud de presupuesto al instalador
  budgetRequest: (project: any) => {
    let installerId: number | null = null;

    if (project.assignedInstaller === 'Carlos RodrÃ­guez') installerId = 4;
    else if (project.assignedInstaller === 'Miguel SÃ¡nchez') installerId = 5;
    else if (project.assignedInstaller === 'Laura MartÃ­nez') installerId = 6;
    else if (project.assignedInstaller === 'Sofia Herrera') installerId = 7;

    if (installerId) {
      const installer = getUserById(installerId);
      if (installer) {
        createNotification({
          userId: installer.id,
          type: 'budget_request',
          title: 'Solicitud de presupuesto',
          message: `Se solicita presupuesto para el proyecto '${project.projectName}' del cliente ${project.clientName}`,
          data: {
            projectId: project.id,
            clientName: project.clientName,
            projectName: project.projectName
          }
        });
      }
    }
  },

  // Instalador propone presupuesto
  budgetProposed: (project: any, installerUserId: number) => {
    const installer = getUserById(installerUserId);

    // NotificaciÃ³n al instalador
    createNotification({
      userId: installerUserId,
      type: 'budget_proposed',
      title: 'Presupuesto propuesto',
      message: `Has propuesto un presupuesto de $${project.installerPriceProposal} para el proyecto '${project.projectName}'`,
      data: {
        projectId: project.id,
        proposedPrice: project.installerPriceProposal,
        comments: project.installerComments
      }
    });

    // NotificaciÃ³n a admin/compras
    const adminUsers = readData().users?.filter((u: any) => u.role === 'admin') || [];
    adminUsers.forEach((user: any) => {
      createNotification({
        userId: user.id,
        type: 'budget_proposed',
        title: 'Presupuesto propuesto por instalador',
        message: `${installer?.name} propone $${project.installerPriceProposal} para '${project.projectName}'`,
        data: {
          projectId: project.id,
          installerName: installer?.name,
          proposedPrice: project.installerPriceProposal
        }
      });
    });
  },

  // Presupuesto aceptado
  budgetAccepted: (project: any) => {
    let installerId: number | null = null;

    if (project.assignedInstaller === 'Carlos RodrÃ­guez') installerId = 4;
    else if (project.assignedInstaller === 'Miguel SÃ¡nchez') installerId = 5;
    else if (project.assignedInstaller === 'Laura MartÃ­nez') installerId = 6;
    else if (project.assignedInstaller === 'Sofia Herrera') installerId = 7;

    if (installerId) {
      const installer = getUserById(installerId);
      if (installer) {
      createNotification({
        userId: installer.id,
        type: 'budget_accepted',
        title: 'Presupuesto aceptado',
        message: `Tu presupuesto de $${project.installerPriceProposal} ha sido aceptado para el proyecto '${project.projectName}'`,
        data: {
          projectId: project.id,
          acceptedPrice: project.installerPriceProposal
        }
      });
    }
  },

  // Presupuesto rechazado
  budgetRejected: (project: any, reason: string) => {
    let installerId: number | null = null;

    if (project.assignedInstaller === 'Carlos RodrÃ­guez') installerId = 4;
    else if (project.assignedInstaller === 'Miguel SÃ¡nchez') installerId = 5;
    else if (project.assignedInstaller === 'Laura MartÃ­nez') installerId = 6;
    else if (project.assignedInstaller === 'Sofia Herrera') installerId = 7;

    if (installerId) {
      const installer = getUserById(installerId);
      if (installer) {
      createNotification({
        userId: installer.id,
        type: 'budget_rejected',
        title: 'Presupuesto rechazado',
        message: `Tu presupuesto de $${project.installerPriceProposal} ha sido rechazado. ${reason}`,
        data: {
          projectId: project.id,
          rejectedPrice: project.installerPriceProposal,
          maxApproved: project.totalCost,
          reason: reason
        }
      });
    }
  },

  // Proyecto iniciado
  projectStarted: (project: any) => {
    // NotificaciÃ³n al instalador
    const installer = getUserById(project.assignedInstaller === 'Carlos RodrÃ­guez' ? 4 :
                                 project.assignedInstaller === 'Miguel SÃ¡nchez' ? 5 :
                                 project.assignedInstaller === 'Laura MartÃ­nez' ? 6 :
                                 project.assignedInstaller === 'Sofia Herrera' ? 7 : null);

    if (installer) {
      createNotification({
        userId: installer.id,
        type: 'project_started',
        title: 'Proyecto iniciado',
        message: `Has iniciado el trabajo en el proyecto '${project.projectName}'`,
        data: {
          projectId: project.id,
          startDate: new Date().toISOString()
        }
      });
    }

    // NotificaciÃ³n al creador del proyecto
    const projectCreator = getUserById(project.createdBy === 'admin' ? 1 : project.createdBy);
    if (projectCreator) {
      createNotification({
        userId: projectCreator.id,
        type: 'project_started',
        title: 'Proyecto en progreso',
        message: `El proyecto '${project.projectName}' ha sido iniciado por ${project.assignedInstaller}`,
        data: {
          projectId: project.id,
          installerName: project.assignedInstaller,
          startDate: new Date().toISOString()
        }
      });
    }
  },

  // Proyecto completado
  projectCompleted: (project: any) => {
    // NotificaciÃ³n al instalador
    const installer = getUserById(project.assignedInstaller === 'Carlos RodrÃ­guez' ? 4 :
                                 project.assignedInstaller === 'Miguel SÃ¡nchez' ? 5 :
                                 project.assignedInstaller === 'Laura MartÃ­nez' ? 6 :
                                 project.assignedInstaller === 'Sofia Herrera' ? 7 : null);

    if (installer) {
      createNotification({
        userId: installer.id,
        type: 'project_completed',
        title: 'Proyecto completado',
        message: `Has completado el proyecto '${project.projectName}'. Esperando aprobaciÃ³n de pago`,
        data: {
          projectId: project.id,
          completionDate: new Date().toISOString()
        }
      });
    }

    // NotificaciÃ³n al creador del proyecto
    const projectCreator = getUserById(project.createdBy === 'admin' ? 1 : project.createdBy);
    if (projectCreator) {
      createNotification({
        userId: projectCreator.id,
        type: 'project_completed',
        title: 'Proyecto completado',
        message: `El proyecto '${project.projectName}' ha sido completado por ${project.assignedInstaller}`,
        data: {
          projectId: project.id,
          installerName: project.assignedInstaller,
          completionDate: new Date().toISOString()
        }
      });
    }
  },

  // Pago aprobado
  paymentApproved: (project: any, approvedByUserId: number) => {
    // NotificaciÃ³n al instalador
    const installer = getUserById(project.assignedInstaller === 'Carlos RodrÃ­guez' ? 4 :
                                 project.assignedInstaller === 'Miguel SÃ¡nchez' ? 5 :
                                 project.assignedInstaller === 'Laura MartÃ­nez' ? 6 :
                                 project.assignedInstaller === 'Sofia Herrera' ? 7 : null);

    if (installer) {
      createNotification({
        userId: installer.id,
        type: 'payment_received',
        title: 'Pago recibido',
        message: `Has recibido el pago de $${project.installerPayment} por el proyecto '${project.projectName}'`,
        data: {
          projectId: project.id,
          amount: project.installerPayment
        }
      });
    }

    // NotificaciÃ³n a admin
    const adminUsers = readData().users?.filter((u: any) => u.role === 'admin') || [];
    adminUsers.forEach((user: any) => {
      createNotification({
        userId: user.id,
        type: 'payment_approved',
        title: 'Pago aprobado',
        message: `Pago de $${project.installerPayment} aprobado para el proyecto '${project.projectName}'`,
        data: {
          projectId: project.id,
          amount: project.installerPayment,
          installerName: project.assignedInstaller
        }
      });
    });
  },

  // MÃ©todo genÃ©rico para crear notificaciones
  createNotification: (notification: {
    userId: number;
    type: string;
    title: string;
    message: string;
    data?: any;
  }) => {
    createNotification(notification);
  }
};