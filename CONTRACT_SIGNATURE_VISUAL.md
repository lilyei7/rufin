# ğŸ¯ Resumen Visual - Sistema de Firma de Contratos

## ğŸ“Š Arquitectura General

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SISTEMA DE FIRMA DE CONTRATOS                 â”‚
â”‚                     (Contract Signature System)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   ADMINISTRADOR      â”‚
                        â”‚   (Dashboard)        â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Generate Token API  â”‚
                        â”‚ POST /api/contracts/â”‚
                        â”‚  generate-token     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                             â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ UUID Token      â”‚        â”‚ 7 Day Expiration  â”‚
            â”‚ Unique          â”‚        â”‚ Stored in DB      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                             â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
            â”‚  Link: /contract/550e8400-e29b-41d4...     â”‚
            â”‚  Â¡Compartible pÃºblicamente!                â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                          â”‚
                    â”‚ (Email/WhatsApp)         â”‚
                    â”‚                          â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
            â”‚         CLIENTE (Sin Login)              â”‚
            â”‚  Accede a: /contract/[token]             â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ GET by-token API      â”‚  â”‚ Valida:              â”‚
        â”‚ Obtiene contrato      â”‚  â”‚ - Token existe       â”‚
        â”‚ Detalles pÃºblicos     â”‚  â”‚ - No expirado        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ - No firmado         â”‚
                â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
        â”‚     Canvas HTML5 - Firma Digital            â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
        â”‚  â”‚  ___________                     â”‚       â”‚
        â”‚  â”‚ /___________\___                 â”‚  âœï¸   â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
        â”‚  [Limpiar]  [Firmar Contrato]              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                      â”‚
                â”‚ Base64 PNG           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
        â”‚  POST /api/contracts/sign            â”‚
        â”‚  {token, signatureData}              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Valida:          â”‚  â”‚ Actualiza BD:      â”‚
        â”‚ - Token          â”‚  â”‚ - isSigned = true  â”‚
        â”‚ - ExpiraciÃ³n     â”‚  â”‚ - status = signed  â”‚
        â”‚ - No firmado     â”‚  â”‚ - Guarda firma B64 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ - signedAt = now   â”‚
                â”‚             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ Crea NotificaciÃ³n para Admin â”‚
            â”‚ type: 'contract_signed'      â”‚
            â”‚ "El contrato #X fue firmado" â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚ âœ… Ã‰xito    â”‚
                    â”‚ Redirige    â”‚
                    â”‚ a home      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Flujo Temporal

```
Timeline del Contrato
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

T0: Contrato Creado
    â”œâ”€ status: 'draft'
    â”œâ”€ isSigned: false
    â””â”€ signatureToken: NULL

T1: Admin Genera Link (Dashboard)
    â”œâ”€ POST /api/contracts/generate-token
    â”œâ”€ Genera UUID Ãºnico
    â”œâ”€ status â†’ 'sent'
    â””â”€ signatureToken: '550e8400-e29b-41d4-a716-446655440000'
    â””â”€ expiresAt: T1 + 7 dÃ­as

T1 + 5 minutos: Cliente Accede Link
    â”œâ”€ GET /api/contracts/by-token?token=550e8400...
    â”œâ”€ Valida: token existe, no expirado, no firmado
    â”œâ”€ Retorna detalles del contrato
    â””â”€ Cliente ve pÃ¡gina de firma

T1 + 20 minutos: Cliente Dibuja Firma
    â”œâ”€ Canvas dibuja firma
    â”œâ”€ Signature Data: data:image/png;base64,...
    â””â”€ POST /api/contracts/sign {token, signatureData}

T1 + 21 minutos: Contrato Firmado âœ…
    â”œâ”€ isSigned: true
    â”œâ”€ signedAt: T1 + 21 minutos
    â”œâ”€ status: 'signed'
    â”œâ”€ signatureData: 'data:image/png;base64,...'
    â””â”€ NotificaciÃ³n â†’ Admin

T1 + 7 dÃ­as: Token Expira â°
    â”œâ”€ Intento de acceso retorna 410 Gone
    â”œâ”€ Cliente no puede firmar despuÃ©s
    â””â”€ Admin puede generar nuevo link si necesario

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“ Estructura de Archivos

```
/home/gordon/Escritorio/rufin/
â”‚
â”œâ”€â”€ ğŸ“„ CONTRACT_SIGNATURE_SYSTEM.md          â† DocumentaciÃ³n Completa
â”œâ”€â”€ ğŸ“„ CONTRACT_SIGNATURE_TESTS.md           â† GuÃ­a de Tests
â”‚
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ contracts/
â”‚   â”‚       â”œâ”€â”€ generate-token/
â”‚   â”‚       â”‚   â””â”€â”€ route.ts                 âœ… Genera UUID + link
â”‚   â”‚       â”œâ”€â”€ by-token/
â”‚   â”‚       â”‚   â””â”€â”€ route.ts                 âœ… Obtiene contrato por token
â”‚   â”‚       â”œâ”€â”€ sign/
â”‚   â”‚       â”‚   â””â”€â”€ route.ts                 âœ… Procesa firma
â”‚   â”‚       â””â”€â”€ route.ts                     âœ… Lista contratos (con auth)
â”‚   â”‚
â”‚   â”œâ”€â”€ contract/
â”‚   â”‚   â””â”€â”€ [token]/
â”‚   â”‚       â””â”€â”€ page.tsx                     âœ… PÃ¡gina pÃºblica de firma
â”‚   â”‚
â”‚   â””â”€â”€ dashboard/
â”‚       â””â”€â”€ contracts/
â”‚           â””â”€â”€ signature-links/
â”‚               â””â”€â”€ page.tsx                 âœ… Panel admin para generar links
â”‚
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma                        âœ… Contract model con signatureToken
â”‚
â””â”€â”€ public/
    â””â”€â”€ data.json                            ğŸ“Š Datos de prueba
```

---

## ğŸ” Matriz de Seguridad

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Recurso           â”‚  Acceso      â”‚  AutenticaciÃ³n â”‚  ValidaciÃ³n  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Admin Dashboard    â”‚ Admin        â”‚ JWT            â”‚ Role=admin   â”‚
â”‚ Generate Link      â”‚ Admin        â”‚ JWT            â”‚ Role=admin   â”‚
â”‚ Public Page        â”‚ Cualquiera   â”‚ Ninguna        â”‚ Token Ãºnico  â”‚
â”‚ By Token API       â”‚ Cualquiera   â”‚ Ninguna        â”‚ Token Ãºnico  â”‚
â”‚ Sign Contract API  â”‚ Cualquiera   â”‚ Ninguna        â”‚ Token Ãºnico  â”‚
â”‚ Get All Contracts  â”‚ Admin        â”‚ JWT            â”‚ Role=admin   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ Base de Datos - Campos Clave

```sql
contracts table
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

id                  INT             PRIMARY KEY
contractNumber      VARCHAR(255)    UNIQUE - Referencia legible
title               VARCHAR(255)    - Nombre del contrato
content             LONGTEXT        - TÃ©rminos y condiciones
totalAmount         DECIMAL(10,2)   - Monto total
status              VARCHAR(50)     - draft | sent | signed | rejected
isSigned            BOOLEAN         - TRUE cuando estÃ¡ firmado
signedAt            DATETIME        - Timestamp de firma

ğŸ”‘ FIRMA DIGITAL
signatureToken      VARCHAR(36)     - UUID Ãºnico (UNIQUE INDEX)
expiresAt           DATETIME        - Token vÃ¡lido 7 dÃ­as
signatureData       LONGTEXT        - Base64 PNG de la firma

ğŸ”‘ RELACIONES
projectId           INT             - FK a projects
incidentId          INT             - FK a incidents
clientId            INT             - FK a users (cliente)
vendorId            INT             - FK a users (vendedor)
installerId         INT             - FK a users (instalador)
createdById         INT             - FK a users (admin que creÃ³)

â° AUDITORÃA
createdAt           DATETIME        - Cuando se creÃ³
updatedAt           DATETIME        - Cuando se modificÃ³ por Ãºltima vez
```

---

## ğŸŒ API Endpoints

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              ENDPOINT 1: Generate Token                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ POST /api/contracts/generate-token                             â•‘
â•‘ Auth: âœ… JWT Required (Admin)                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Request:                                                        â•‘
â•‘ {                                                              â•‘
â•‘   "contractId": 123                                            â•‘
â•‘ }                                                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Response 200:                                                   â•‘
â•‘ {                                                              â•‘
â•‘   "signatureToken": "550e8400-e29b-41d4-a716-...",            â•‘
â•‘   "expiresAt": "2024-01-22T10:30:00.000Z",                    â•‘
â•‘   "publicUrl": "http://localhost:3001/contract/550e8400..."   â•‘
â•‘ }                                                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Response 401: Unauthorized                                     â•‘
â•‘ Response 404: Contract not found                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              ENDPOINT 2: Get By Token                          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ GET /api/contracts/by-token?token=550e8400...                 â•‘
â•‘ Auth: âŒ Public Access                                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Response 200:                                                   â•‘
â•‘ {                                                              â•‘
â•‘   "id": 123,                                                   â•‘
â•‘   "contractNumber": "CTR-001",                                 â•‘
â•‘   "title": "Contrato...",                                      â•‘
â•‘   "content": "TÃ©rminos...",                                    â•‘
â•‘   "totalAmount": 5000.00,                                      â•‘
â•‘   "status": "sent",                                            â•‘
â•‘   "expiresAt": "2024-01-22T10:30:00.000Z"                     â•‘
â•‘ }                                                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Response 404: Contrato no encontrado                           â•‘
â•‘ Response 410: El link de firma ha expirado                     â•‘
â•‘ Response 400: Este contrato ya ha sido firmado                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              ENDPOINT 3: Sign Contract                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ POST /api/contracts/sign                                       â•‘
â•‘ Auth: âŒ Public Access                                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Request:                                                        â•‘
â•‘ {                                                              â•‘
â•‘   "token": "550e8400-e29b-41d4-a716-...",                     â•‘
â•‘   "signatureData": "data:image/png;base64,iVBORw0KGgo..."     â•‘
â•‘ }                                                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Response 200:                                                   â•‘
â•‘ {                                                              â•‘
â•‘   "success": true,                                             â•‘
â•‘   "contractId": 123,                                           â•‘
â•‘   "signedAt": "2024-01-15T11:45:00.000Z"                      â•‘
â•‘ }                                                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Response 400: Token/Contrato ya firmado                        â•‘
â•‘ Response 404: Contract not found                               â•‘
â•‘ Response 410: Token expirado                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ¨ UI Components Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Admin Dashboard - Signature Links                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â† Volver                                                   â”‚
â”‚  ğŸ“‹ Generar Links de Firma                                  â”‚
â”‚  Crea links pÃºblicos para que los clientes firmen contratos â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Contratos Disponibles   â”‚  Detalles del Contrato    â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                          â”‚                            â”‚   â”‚
â”‚  â”‚ â—‹ CTR-001 â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚ NÃºmero: CTR-001           â”‚   â”‚
â”‚  â”‚   InstalaciÃ³n Solar      â”‚ TÃ­tulo: InstalaciÃ³n...    â”‚   â”‚
â”‚  â”‚   $5,000.00              â”‚ Monto: $5,000.00          â”‚   â”‚
â”‚  â”‚   â³ Pendiente           â”‚ Estado: Por Firmar        â”‚   â”‚
â”‚  â”‚                          â”‚                            â”‚   â”‚
â”‚  â”‚ â—‹ CTR-002                â”‚ [ğŸ”— Generar Link Firma]   â”‚   â”‚
â”‚  â”‚   Mantenimiento          â”‚                            â”‚   â”‚
â”‚  â”‚   $1,200.00              â”‚ ğŸ”— LINK GENERADO           â”‚   â”‚
â”‚  â”‚   âœ… Firmado             â”‚ https://app.com/...       â”‚   â”‚
â”‚  â”‚                          â”‚ [ğŸ“‹ Copiar]               â”‚   â”‚
â”‚  â”‚                          â”‚                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  ğŸ“ CÃ³mo Funciona                                            â”‚
â”‚  1 Selecciona un contrato de la lista                       â”‚
â”‚  2 Haz clic en "Generar Link de Firma"                      â”‚
â”‚  3 Copia el link y comparte con el cliente                  â”‚
â”‚  4 El cliente firma digitalmente en el link (vÃ¡lido 7 dÃ­as) â”‚
â”‚  5 Recibes una notificaciÃ³n cuando se firme                 â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Cliente - PÃ¡gina PÃºblica de Firma                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  ğŸ“‹ Firmar Contrato                                          â”‚
â”‚  Revisa los detalles y firma digitalmente                   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Contrato #: CTR-001                             â”‚        â”‚
â”‚  â”‚ TÃ­tulo: Contrato de InstalaciÃ³n Solar           â”‚        â”‚
â”‚  â”‚ Monto: $5,000.00                                â”‚        â”‚
â”‚  â”‚ VÃ¡lido hasta: 22/01/2024                        â”‚        â”‚
â”‚  â”‚                                                 â”‚        â”‚
â”‚  â”‚ TÃ©rminos y Condiciones:                         â”‚        â”‚
â”‚  â”‚ [Scroll area con tÃ©rminos...]                   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                              â”‚
â”‚  âœï¸ Tu Firma Digital                                        â”‚
â”‚  Dibuja tu firma en el cuadro de abajo                      â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚                                            â”‚             â”‚
â”‚  â”‚    (canvas para dibujar firma)             â”‚             â”‚
â”‚  â”‚                                            â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                              â”‚
â”‚  [ğŸ”„ Limpiar]  [âœ… Firmar Contrato]                        â”‚
â”‚                                                              â”‚
â”‚  âš–ï¸ Aviso Legal                                             â”‚
â”‚  Al firmar este contrato digitalmente, aceptas los tÃ©rminos â”‚
â”‚  y condiciones descritos arriba. Esta firma es vinculante... â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ Ciclo de Vida del Token

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CICLO DE VIDA DEL TOKEN                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚ 1. GENERACIÃ“N                                                  â”‚
â”‚    â”œâ”€ Admin: POST /api/contracts/generate-token              â”‚
â”‚    â”œâ”€ UUID: 550e8400-e29b-41d4-a716-446655440000             â”‚
â”‚    â”œâ”€ ExpiresAt: HOY + 7 DÃAS                                â”‚
â”‚    â””â”€ Guardar en contracts.signatureToken                     â”‚
â”‚                                                                â”‚
â”‚ 2. COMPARTIMIENTO                                              â”‚
â”‚    â”œâ”€ Admin copia: /contract/550e8400...                      â”‚
â”‚    â”œâ”€ EnvÃ­a al cliente vÃ­a: Email, WhatsApp, SMS              â”‚
â”‚    â””â”€ Link vÃ¡lido: 7 dÃ­as                                     â”‚
â”‚                                                                â”‚
â”‚ 3. ACCESO CLIENTE                                              â”‚
â”‚    â”œâ”€ Cliente: GET /api/contracts/by-token?token=550e8400     â”‚
â”‚    â”œâ”€ ValidaciÃ³n: âœ… Existe, âœ… No expirado, âœ… Sin firmar    â”‚
â”‚    â”œâ”€ Retorna: Detalles contrato                              â”‚
â”‚    â””â”€ Cliente ve: PÃ¡gina de firma                             â”‚
â”‚                                                                â”‚
â”‚ 4. FIRMA                                                       â”‚
â”‚    â”œâ”€ Cliente: POST /api/contracts/sign                       â”‚
â”‚    â”œâ”€ Datos: token + signatureData (base64)                   â”‚
â”‚    â”œâ”€ ValidaciÃ³n: âœ… Token vÃ¡lido, âœ… No expirado             â”‚
â”‚    â””â”€ Resultado: âœ… Contrato Firmado                          â”‚
â”‚                                                                â”‚
â”‚ 5. EXPIRACIÃ“N (Si no se firma)                                â”‚
â”‚    â”œâ”€ DespuÃ©s de 7 dÃ­as                                       â”‚
â”‚    â”œâ”€ GET /api/contracts/by-token â†’ 410 Gone                  â”‚
â”‚    â”œâ”€ Token: INVÃLIDO / EXPIRADO                              â”‚
â”‚    â””â”€ Admin: Puede generar nuevo link                         â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ESTADOS DEL CONTRATO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

draft    â†’  sent    â†’  signed
  â†“         â†“          â†“
Sin        Link        Firma
token      generado    exitosa
```

---

## âœ¨ CaracterÃ­sticas Implementadas

```
âœ… Generar Links Ãšnicos (UUID)
âœ… ExpiraciÃ³n AutomÃ¡tica (7 dÃ­as)
âœ… Acceso PÃºblico Sin Login
âœ… Canvas HTML5 para Firma Digital
âœ… Validaciones Robustas
âœ… Base64 PNG Storage
âœ… Notificaciones a Admin
âœ… UI Responsiva (Mobile + Desktop)
âœ… Manejo de Errores
âœ… DocumentaciÃ³n Completa
```

---

## ğŸš€ PrÃ³ximas Mejoras

```
â³ PDF con Firma Insertada
â³ Email AutomÃ¡tico con Link
â³ MÃºltiples Firmas (Cliente + Vendor + Instalador)
â³ Historial de Intentos
â³ Rechazo de Contratos
â³ E-firma Certificada (LGPD)
â³ QR para Firma MÃ³vil
â³ IntegraciÃ³n WhatsApp
```

---

**Sistema Completo y Funcional âœ…**
**Ãšltima ActualizaciÃ³n: 2024-01-15**
